<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥è¡Œç§‘å…¬æ–‡é è­¦ç³»çµ± V1.32</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background-color: #f4f4f9; }
        h2 { color: #333; border-left: 5px solid #007bff; padding-left: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        #connection-warning { color: red; font-size: 0.6em; background: #ffecec; padding: 5px 10px; border-radius: 5px; transition: opacity 0.5s; margin: 0; font-weight: normal; margin-left: auto; margin-right: 10px; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #007bff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { margin-top: 15px; font-weight: bold; color: #555; }
        h3 { color: #2c3e50; margin-top: 10px; border-bottom: 2px solid #ddd; padding-bottom: 5px; font-size: 1.2em; }
        .clickable-header { cursor: pointer; user-select: none; transition: color 0.2s; }
        .clickable-header:hover { color: #17a2b8; }
        .section-divider { border: 0; border-top: 4px double #b0b0b0; margin: 50px 0 30px 0; }
        .input-group { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: flex-end; }
        .input-item { display: flex; flex-direction: column; }
        label { font-size: 0.9em; margin-bottom: 5px; font-weight: bold; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        input:focus::placeholder { color: transparent; }
        button { padding: 9px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-family: "Microsoft JhengHei", sans-serif; font-size: 16px; line-height: 1.2; }
        button:active { transform: translateY(1px); }
        .add-btn { background-color: #28a745; color: white; }
        .add-btn:hover { background-color: #218838; }
        .clear-btn { background-color: #ffc107; color: #333; }
        .clear-btn:hover { background-color: #e0a800; }
        .test-btn { background-color: #6c757d; color: white; }
        .test-btn:hover { background-color: #5a6268; }
        .table-btn { padding: 5px 2px; font-size: 14px; width: auto; flex: 1; }
        .delete-btn { background-color: #dc3545; color: white; }
        .delete-btn:hover { background-color: #c82333; }
        .edit-btn { background-color: #17a2b8; color: white; } 
        .edit-btn:hover { background-color: #138496; }
        .ok-btn { background-color: #28a745; color: white; }
        .ok-btn:hover { background-color: #218838; }
        .cancel-btn { background-color: #6c757d; color: white; }
        .cancel-btn:hover { background-color: #5a6268; }
        .action-btns { display: flex; gap: 4px; justify-content: space-between; }
        .confirm-btn { background-color: #17a2b8; color: white; padding: 5px 10px; font-size: 14px; margin-left: 5px; }
        table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); table-layout: fixed; margin-bottom: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; word-wrap: break-word; font-size: 0.95em; vertical-align: top; }
        th { background-color: #2c3e50; color: white; text-align: center; }
        th:nth-child(2), td:nth-child(2) { display: none; }
        td:nth-child(3), td:nth-child(4), td:nth-child(6), td:nth-child(7), td:nth-child(8), td:nth-child(9) { text-align: center; }
        
        /* æ¬„ä½å¯¬åº¦ V1.32 */
        th:nth-child(1) { width: 110px; }
        th:nth-child(3) { width: 80px; }
        th:nth-child(4) { width: 160px; }
        th:nth-child(5) { width: 220px; }
        th:nth-child(6), th:nth-child(7) { width: 90px; }
        th:nth-child(8) { width: 160px; }
        th:nth-child(9) { width: 80px; }

        .edit-input { width: 100%; padding: 4px; box-sizing: border-box; border: 1px solid #007bff; border-radius: 4px; font-family: inherit; font-size: 0.95em; }
        .warn-yellow { background-color: #fff3cd !important; color: #856404; font-weight: bold; }
        .warn-red { background-color: #f8d7da !important; color: #721c24; font-weight: bold; }
        .warn-deepred { background-color: #b02a37 !important; color: #fff; font-weight: bold; }
        .status-closed { color: #28a745; font-weight: bold; }
        .status-open { color: #dc3545; }
        .warn-deepred .status-open { color: #fff !important; }
        .result-ok { color: #28a745; font-weight: bold; }
        .result-overdue { color: #dc3545; font-weight: bold; }
        .subject-content { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; cursor: pointer; line-height: 1.5em; max-height: 4.5em; transition: max-height 0.3s ease; }
        .subject-content:hover { opacity: 0.8; }
        .subject-content.expanded { -webkit-line-clamp: unset; max-height: none; overflow: visible; background-color: rgba(255,255,255,0.9); box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 4px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">è³‡æ–™åŒæ­¥ä¸­...</div>
    </div>

    <h2>
        <div>å·¥è¡Œç§‘å…¬æ–‡é è­¦ç³»çµ±</div>
        <div style="display:flex; align-items:center;">
            <p id="connection-warning">âš ï¸ ç³»çµ±å·²é€£æ¥è‡³ Google é›²ç«¯è³‡æ–™åº«ï¼Œæ“ä½œæ™‚è«‹ä¿æŒç¶²è·¯é€£ç·šã€‚</p>
            <button type="button" class="test-btn" onclick="testConnection()">é€£ç·šæª¢æŸ¥</button>
        </div>
    </h2>

    <div class="input-group">
        <div class="input-item"><label>æ‰¿è¾¦äºº</label><input type="text" id="undertaker" placeholder="å§“å" style="width: 80px;"></div>
        <div class="input-item"><label>æ–‡è™Ÿ</label><input type="text" id="docNo" placeholder="ä¾‹:1140001234"></div>
        <div class="input-item"><label>ä¸»æ—¨</label><input type="text" id="subject" placeholder="è«‹è¼¸å…¥ä¸»æ—¨" style="width: 250px;"></div>
        <div class="input-item"><label>æ”¶å‰µæ—¥æœŸ</label><input type="text" id="createDate" placeholder="ä¾‹:1140101" maxlength="10" oninput="calculateDeadline()"></div>
        <div class="input-item"><label>äºŒå±•æœŸé™ (è‡ªå‹•è¨ˆç®—)</label><input type="text" id="deadline" placeholder="æ”¶å‰µæ—¥æœŸ+23å·¥ä½œå¤©" maxlength="10" onchange="checkDateLogic()"></div>
        <button type="button" class="add-btn" onclick="addDoc()">æ–°å¢åˆ—ç®¡</button>
        <button type="button" class="clear-btn" onclick="clearInputs()">æ¸…é™¤å…§å®¹</button>
    </div>

    <h3 id="openSectionTitle">ğŸ“‚ åˆ—ç®¡ä¸­å…¬æ–‡ï¼ˆè®€å–ä¸­...ï¼‰</h3>
    <table>
        <thead><tr><th>æ“ä½œ</th><th>ç‹€æ…‹</th><th>æ‰¿è¾¦äºº</th><th>æ–‡è™Ÿ</th><th>ä¸»æ—¨</th><th>æ”¶å‰µæ—¥æœŸ</th><th>äºŒå±•æœŸé™</th><th>çµæ¡ˆæ—¥æœŸ</th><th>å‰©é¤˜å¤©æ•¸</th></tr></thead>
        <tbody id="openDocList"></tbody>
    </table>

    <hr class="section-divider">

    <h3 id="closedSectionTitle" class="clickable-header" onclick="toggleClosedSection()" title="é»æ“Šå±•é–‹/æ”¶åˆ">ğŸ—„ï¸ å·²çµæ¡ˆå…¬æ–‡ â–¶</h3>
    <table id="closedTable" style="display: none;">
        <thead><tr><th>æ“ä½œ</th><th>ç‹€æ…‹</th><th>æ‰¿è¾¦äºº</th><th>æ–‡è™Ÿ</th><th>ä¸»æ—¨</th><th>æ”¶å‰µæ—¥æœŸ</th><th>äºŒå±•æœŸé™</th><th>çµæ¡ˆæ—¥æœŸ</th><th>å‰©é¤˜å¤©æ•¸</th></tr></thead>
        <tbody id="closedDocList"></tbody>
    </table>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            alert(`ã€ç³»çµ±åµæ¸¬åˆ°éŒ¯èª¤ã€‘\nè¨Šæ¯: ${message}\nè«‹æˆªåœ–å‘ŠçŸ¥å·¥ç¨‹å¸«ï¼Œä¸¦æª¢æŸ¥æ˜¯å¦æœ‰è³‡æ–™æ ¼å¼ç•°å¸¸ã€‚`);
            return true;
        };

        const API_URL = "https://script.google.com/macros/s/AKfycbwxUFhtmFi9XSvTzKeskwJvu1PL9X_UchCKa5NTUnLb5Lzn-a3PmgUBZK0FYRz783ty4w/exec"; 
        
        let allDocs = []; 
        let isClosedSectionExpanded = false;
        let editingId = null; 

        const holidays = ['2025-01-01', '2025-01-27', '2025-01-28', '2025-01-29', '2025-01-30', '2025-01-31', '2025-02-28', '2025-04-03', '2025-04-04', '2025-05-30', '2025-10-06', '2025-10-10', '2026-01-01', '2026-01-02', '2026-02-16', '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', '2026-02-27', '2026-04-03', '2026-04-06', '2026-06-19', '2026-09-25', '2026-10-09'];
        const makeUpWorkDays = ['2025-02-08'];

        window.onload = function() {
            if (!API_URL) { alert("è«‹è¨­å®š API_URL"); return; }
            fetchData();
        };

        function isWorkDay(date) {
            const y = date.getFullYear();
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const d = date.getDate().toString().padStart(2, '0');
            const dateString = `${y}-${m}-${d}`;
            const dayOfWeek = date.getDay();
            if (makeUpWorkDays.includes(dateString)) return true;
            if (holidays.includes(dateString)) return false;
            if (dayOfWeek === 0 || dayOfWeek === 6) return false;
            return true;
        }

        function countWorkDays(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return 0;
            
            if (endDate < startDate) return -1;
            let count = 0;
            let current = new Date(startDate);
            current.setHours(0,0,0,0);
            const end = new Date(endDate);
            end.setHours(0,0,0,0);

            while (current.getTime() < end.getTime()) {
                current.setDate(current.getDate() + 1);
                if (isWorkDay(current)) count++;
            }
            return count;
        }

        function calculateDeadline() {
            try {
                const createDateStr = document.getElementById('createDate').value.trim();
                if (!createDateStr) return;
                const isoStartDate = rocToIso(createDateStr);
                if (!isoStartDate) return; 
                const targetDate = addWorkDays(isoStartDate, 23);
                document.getElementById('deadline').value = displayROC(targetDate);
            } catch (e) { console.error(e); }
        }

        function calculateDeadlineForEdit(id) {
            try {
                const createDateStr = document.getElementById('edit_create_' + id).value.trim();
                if (!createDateStr) return;
                const isoStartDate = rocToIso(createDateStr);
                if (!isoStartDate) return; 
                const targetDate = addWorkDays(isoStartDate, 23);
                document.getElementById('edit_deadline_' + id).value = displayROC(targetDate);
            } catch (e) { console.error(e); }
        }

        function addWorkDays(startDateStr, daysToAdd) {
            let currentDate = new Date(startDateStr);
            let addedDays = 0;
            while (addedDays < daysToAdd) {
                currentDate.setDate(currentDate.getDate() + 1);
                if (isWorkDay(currentDate)) addedDays++;
            }
            const y = currentDate.getFullYear();
            const m = (currentDate.getMonth() + 1).toString().padStart(2, '0');
            const d = currentDate.getDate().toString().padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function testConnection() {
            toggleLoading(true);
            fetch(API_URL + "?action=read")
                .then(response => response.text().then(text => {
                    try {
                        JSON.parse(text);
                        alert("âœ… é€£ç·šæˆåŠŸï¼");
                        autoHideWarning();
                    } catch (e) {
                        alert("âŒ é€£ç·šç•°å¸¸ï¼Œå¯èƒ½æ˜¯æ¬Šé™ä¸è¶³ã€‚\nå›æ‡‰å…§å®¹: " + text.substring(0, 50));
                    }
                }))
                .catch(error => alert("âŒ ç¶²è·¯éŒ¯èª¤: " + error))
                .finally(() => toggleLoading(false));
        }

        function autoHideWarning() {
            const warning = document.getElementById('connection-warning');
            if (warning) {
                setTimeout(() => {
                    warning.style.opacity = '0'; 
                    setTimeout(() => warning.style.display = 'none', 500);
                }, 3000);
            }
        }

        function toggleLoading(show) {
            const el = document.getElementById('loadingOverlay');
            if(el) el.style.display = show ? 'flex' : 'none';
        }

        function fetchData() {
            toggleLoading(true);
            fetch(API_URL + "?action=read")
                .then(res => res.json())
                .then(result => {
                    if (result.status === "success") {
                        allDocs = result.data;
                        try {
                            renderTable();
                            checkAlerts();
                            autoHideWarning();
                        } catch (renderError) {
                            console.error(renderError);
                            alert("âš ï¸ è³‡æ–™è®€å–æˆåŠŸï¼Œä½†é¡¯ç¤ºæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚\nå¯èƒ½æ˜¯æœ‰å£æ‰çš„è³‡æ–™ï¼Œè«‹æª¢æŸ¥ Google Sheetã€‚");
                        }
                    } else {
                        alert("è®€å–å¤±æ•—ï¼š" + result.message);
                    }
                })
                .catch(err => alert("é€£ç·šéŒ¯èª¤: " + err))
                .finally(() => toggleLoading(false));
        }

        function addDoc() {
            if (editingId) { alert("è«‹å…ˆå®Œæˆæˆ–å–æ¶ˆç›®å‰çš„ä¿®æ”¹æ“ä½œã€‚"); return; }
            const undertaker = document.getElementById('undertaker').value.trim();
            const subject = document.getElementById('subject').value.trim();
            const docNo = document.getElementById('docNo').value.trim();
            const rawCreateDate = document.getElementById('createDate').value.trim();
            const rawDeadline = document.getElementById('deadline').value.trim();

            if (!undertaker || !subject || !docNo || !rawCreateDate || !rawDeadline) {
                alert('æ‰€æœ‰æ¬„ä½(åŒ…å«æ‰¿è¾¦äºº)çš†ç‚ºå¿…å¡«ã€‚'); return;
            }

            const isDuplicate = allDocs.some(doc => String(doc.docNo) === String(docNo));
            if (isDuplicate) {
                alert(`ã€éŒ¯èª¤ã€‘æ–‡è™Ÿ ${docNo} å·²å­˜åœ¨ï¼\nè«‹å‹¿é‡è¤‡éŒ„æ¡ˆã€‚`);
                return;
            }

            const isoCreateDate = rocToIso(rawCreateDate);
            const isoDeadline = rocToIso(rawDeadline);
            if (!isoCreateDate || !isoDeadline) { alert('æ—¥æœŸæ ¼å¼éŒ¯èª¤ (ä¾‹:1140101)'); return; }
            
            toggleLoading(true);
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'add',
                    id: Date.now(),
                    undertaker: undertaker,
                    subject: subject,
                    docNo: docNo,
                    createDate: isoCreateDate,
                    deadline: isoDeadline
                })
            })
            .then(res => res.json())
            .then(result => {
                if(result.status === "success") { clearInputs(); fetchData(); }
                else { alert("æ–°å¢å¤±æ•—ï¼š" + result.message); }
            })
            .catch(err => alert("é€£ç·šéŒ¯èª¤"))
            .finally(() => toggleLoading(false));
        }

        function confirmUpdate(id) {
            const undertaker = document.getElementById('edit_undertaker_' + id).value.trim();
            const subject = document.getElementById('edit_subject_' + id).value.trim();
            const docNo = document.getElementById('edit_docNo_' + id).value.trim();
            const rawCreateDate = document.getElementById('edit_create_' + id).value.trim();
            const rawDeadline = document.getElementById('edit_deadline_' + id).value.trim();

            if (!undertaker || !subject || !docNo || !rawCreateDate || !rawDeadline) { alert('æ‰€æœ‰æ¬„ä½çš†ç‚ºå¿…å¡«ã€‚'); return; }
            
            const isDuplicate = allDocs.some(doc => String(doc.id) !== String(id) && String(doc.docNo) === String(docNo));
            if (isDuplicate) { if(!confirm(`æ–‡è™Ÿ ${docNo} å·²å­˜åœ¨ï¼Œç¢ºå®šè¦ä½¿ç”¨å—ï¼Ÿ`)) return; }

            const isoCreateDate = rocToIso(rawCreateDate);
            const isoDeadline = rocToIso(rawDeadline);
            if (!isoCreateDate || !isoDeadline) { alert('æ—¥æœŸæ ¼å¼éŒ¯èª¤'); return; }
            
            toggleLoading(true);
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'edit',
                    id: id,
                    undertaker: undertaker,
                    subject: subject,
                    docNo: docNo,
                    createDate: isoCreateDate,
                    deadline: isoDeadline
                })
            })
            .then(res => res.json())
            .then(result => {
                if(result.status === "success") { editingId = null; fetchData(); }
                else { alert("ä¿®æ”¹å¤±æ•—ï¼š" + result.message); }
            })
            .catch(err => alert("é€£ç·šéŒ¯èª¤"))
            .finally(() => toggleLoading(false));
        }

        function editDoc(id) {
            if (editingId) { if(!confirm("è¦æ”¾æ£„ç›®å‰çš„ç·¨è¼¯å—ï¼Ÿ")) return; }
            editingId = id;
            renderTable(); 
        }

        function cancelEdit() { editingId = null; renderTable(); }
        function clearInputs() { document.querySelectorAll('.input-group input').forEach(el => el.value = ''); }

        function deleteDoc(id) {
            if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ')) return;
            toggleLoading(true);
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id: id }) })
            .then(res => res.json())
            .then(result => { if(result.status === "success") fetchData(); else alert("åˆªé™¤å¤±æ•—"); })
            .catch(err => alert("é€£ç·šéŒ¯èª¤"))
            .finally(() => toggleLoading(false));
        }

        function manualClose(id) {
            const inputId = 'close_date_' + id;
            const rawDate = document.getElementById(inputId).value.trim();
            let isoDate = "";
            if (rawDate !== "") {
                isoDate = rocToIso(rawDate);
                if (!isoDate) { alert('æ—¥æœŸæ ¼å¼éŒ¯èª¤'); return; }
            } else {
                if(!confirm("ç¢ºå®šè¦å°‡æ­¤æ¡ˆæ¢å¾©ç‚ºã€Œè¾¦ç†ä¸­ã€å—ï¼Ÿ")) return;
            }
            toggleLoading(true);
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'update', id: id, closeDate: isoDate }) })
            .then(res => res.json())
            .then(result => { if(result.status === "success") fetchData(); else alert("æ›´æ–°å¤±æ•—"); })
            .catch(err => alert("é€£ç·šéŒ¯èª¤"))
            .finally(() => toggleLoading(false));
        }

        function toggleClosedSection() {
            isClosedSectionExpanded = !isClosedSectionExpanded;
            document.getElementById('closedTable').style.display = isClosedSectionExpanded ? 'table' : 'none';
            renderClosedTitle();
        }
        
        function renderClosedTitle() {
            let closedDocs = allDocs.filter(d => d.closeDate);
            document.getElementById('closedSectionTitle').textContent = `ğŸ—„ï¸ å·²çµæ¡ˆå…¬æ–‡ï¼ˆ${closedDocs.length} ä»¶ï¼‰ ${isClosedSectionExpanded ? 'â–¼' : 'â–¶'}`;
        }

        function renderTable() {
            const openTbody = document.getElementById('openDocList');
            const closedTbody = document.getElementById('closedDocList');
            openTbody.innerHTML = '';
            closedTbody.innerHTML = '';
            
            const today = new Date(); today.setHours(0,0,0,0);
            
            let openDocs = allDocs.filter(d => !d.closeDate);
            let closedDocs = allDocs.filter(d => d.closeDate);

            document.getElementById('openSectionTitle').textContent = `ğŸ“‚ åˆ—ç®¡ä¸­å…¬æ–‡ï¼ˆ${openDocs.length} ä»¶ï¼‰`;
            renderClosedTitle();

            openDocs.sort((a, b) => {
                const dateA = new Date(a.deadline);
                const dateB = new Date(b.deadline);
                if (dateA < dateB) return -1;
                if (dateA > dateB) return 1;
                return String(a.docNo).localeCompare(String(b.docNo), 'zh-Hant-TW', { numeric: true });
            });
            closedDocs.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));

            openDocs.forEach(doc => {
                try { insertRow(openTbody, doc, today, false); } catch(e) { console.warn("Skipped bad row", doc, e); }
            });
            closedDocs.forEach(doc => {
                try { insertRow(closedTbody, doc, today, true); } catch(e) { console.warn("Skipped bad row", doc, e); }
            });
        }

        function insertRow(tbody, doc, today, isClosed) {
            const tr = document.createElement('tr');
            const isEditing = (String(doc.id) === String(editingId));
            const deadlineDate = new Date(doc.deadline);
            const diffDays = countWorkDays(today, deadlineDate);

            if (!isClosed && !isEditing) {
                if (diffDays <= 1) tr.className = 'warn-deepred'; 
                else if (diffDays <= 2) tr.className = 'warn-red';      
                else if (diffDays <= 4) tr.className = 'warn-yellow';   
            }

            if (isEditing) {
                tr.style.backgroundColor = "#e8f0fe"; 
                tr.innerHTML = `
                    <td>
                        <div class="action-btns">
                            <button type="button" class="table-btn ok-btn" onclick="confirmUpdate('${doc.id}')">ç¢ºèª</button>
                            <button type="button" class="table-btn cancel-btn" onclick="cancelEdit()">å–æ¶ˆ</button>
                        </div>
                    </td>
                    <td>ç·¨è¼¯ä¸­</td>
                    <td><input type="text" class="edit-input" id="edit_undertaker_${doc.id}" value="${doc.undertaker || ''}"></td>
                    <td><input type="text" class="edit-input" id="edit_docNo_${doc.id}" value="${doc.docNo}"></td>
                    <td><input type="text" class="edit-input" id="edit_subject_${doc.id}" value="${doc.subject}"></td>
                    <td><input type="text" class="edit-input" id="edit_create_${doc.id}" value="${displayROC(doc.createDate)}" oninput="calculateDeadlineForEdit('${doc.id}')"></td>
                    <td><input type="text" class="edit-input" id="edit_deadline_${doc.id}" value="${displayROC(doc.deadline)}"></td>
                    <td colspan="2" style="text-align:center; color:#666;">(ä¿®æ”¹æ¨¡å¼)</td>
                `;
            } else {
                const statusHtml = isClosed ? '<span class="status-closed">å·²çµæ¡ˆ</span>' : '<span class="status-open">è¾¦ç†ä¸­</span>';
                const daysDisplay = (diffDays === 0) ? "ä»Šå¤©åˆ°æœŸ" : `${diffDays} å¤©`;
                const resultText = isClosed ? (doc.closeDate > doc.deadline ? '<span class="result-overdue">é€¾æœŸçµæ¡ˆ</span>' : '<span class="result-ok">æœªé€¾æœŸ</span>') : daysDisplay;
                const btnText = isClosed ? 'ä¿®æ”¹' : 'ç¢ºèª';
                const dateValue = isClosed ? displayROC(doc.closeDate) : '';

                tr.innerHTML = `
                    <td>
                        <div class="action-btns">
                            <button type="button" class="table-btn edit-btn" onclick="editDoc('${doc.id}')">ä¿®æ”¹</button>
                            <button type="button" class="table-btn delete-btn" onclick="deleteDoc('${doc.id}')">åˆªé™¤</button>
                        </div>
                    </td>
                    <td>${statusHtml}</td>
                    <td>${doc.undertaker || ''}</td>
                    <td>${doc.docNo}</td>
                    <td><div class="subject-content" onclick="toggleSubject(this)">${doc.subject}</div></td>
                    <td>${displayROC(doc.createDate)}</td>
                    <td>${displayROC(doc.deadline)}</td>
                    <td>
                        <div style="display:flex; align-items:center; justify-content: center;">
                            <input type="text" id="close_date_${doc.id}" value="${dateValue}" placeholder="ä¾‹:1140101" style="width:90px; padding:4px;">
                            <button type="button" class="confirm-btn" onclick="manualClose('${doc.id}')">${btnText}</button>
                        </div>
                    </td>
                    <td>${resultText}</td>
                `;
            }
            tbody.appendChild(tr);
        }

        function toggleSubject(el) { el.classList.toggle('expanded'); }
        function checkDateLogic() { /* ä¿æŒåŸæ¨£ */ }
        function rocToIso(str) {
            if (!str) return null;
            if (str.match(/^\d{4}-\d{2}-\d{2}$/)) return str;
            const nums = str.replace(/[^\d]/g, '');
            let y, m, d;
            if (nums.length === 7) { 
                y = parseInt(nums.substring(0,3)); m = nums.substring(3,5); d = nums.substring(5,7); 
            } else if (str.split(/[\/\-\.]/).length === 3) { 
                const p = str.split(/[\/\-\.]/); y = parseInt(p[0]); m = p[1].padStart(2,'0'); d = p[2].padStart(2,'0'); 
            } else return null;
            return `${y+1911}-${m}-${d}`;
        }

        function displayROC(isoStr) {
            if (!isoStr) return '';
            let dateStr = String(isoStr);
            const date = new Date(dateStr.substring(0,10));
            if (isNaN(date.getTime())) return '';
            return `${date.getFullYear()-1911}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')}`;
        }
        
        function checkAlerts() {
            const today = new Date(); today.setHours(0,0,0,0);
            let alertMsg = "", count = 0;
            allDocs.forEach(doc => {
                if (!doc.closeDate) {
                    const diff = countWorkDays(today, new Date(doc.deadline));
                    if (diff <= 4) {
                        count++;
                        let u = diff <= 1 ? "ã€ç·Šæ€¥ã€‘" : (diff <= 2 ? "ã€æ€¥ã€‘" : "ã€æé†’ã€‘");
                        alertMsg += `â— ${u} æ–‡è™Ÿ ${doc.docNo} (å‰© ${diff} å¤©)\n`;
                    }
                }
            });
            if (count > 0) setTimeout(() => alert(`ã€é è­¦ã€‘æœ‰ ${count} ä»¶éœ€æ³¨æ„ï¼\n\n${alertMsg}`), 500);
        }
    </script>
</body>
</html>
